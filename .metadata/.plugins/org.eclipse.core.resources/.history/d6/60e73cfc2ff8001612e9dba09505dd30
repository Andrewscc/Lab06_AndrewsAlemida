package Central_de_Games;

import java.util.ArrayList;

import Exceptions.ParametroNuloOuVazio;
import Exceptions.UsuarioJaCadastrado;

public class Loja {

	private ArrayList<Usuario> listaUsuarios;
	public final String NL = System.lineSeparator();

	public Loja() {

		/**
		 * Classe que representa a loja
		 * 
		 * @author Andrews
		 */
		this.listaUsuarios = new ArrayList<>();
	}

	/**
	 * Adiciona um usuário a loja caso ele ainda não esteja, lançando exceção se
	 * já for cadastrado na loja ou seo método receber parametros inválidos
	 * 
	 * @param novoUsuario
	 */
	public void adicionaUsuario(Usuario novoUsuario) {
		try {
			if (novoUsuario == null) {
				throw new ParametroNuloOuVazio("Usuario não pode ser nulo");
			} else if (listaUsuarios.contains(novoUsuario)) {
				throw new UsuarioJaCadastrado("Usúario já cadastrado");
			} else {
				listaUsuarios.add(novoUsuario);

			}
		} catch (Exception e) {
			e.printStackTrace();

		}
	}

	/**
	 * Efetua busca de usuário por login,retornando uma instancia da classe
	 * usuario e lançando exceção caso a string passada seja vazia ou nula
	 * 
	 * @param login
	 * @return
	 */
	public Usuario usuarioPorLogin(String login) {
		try {
			if (!login.trim().equals(""))
				for (Usuario novoUsuario : listaUsuarios)
					if (novoUsuario.getLogin().equals(login))
						return novoUsuario;
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}

	/**
	 * Adiciona dinheiro na conta de um usuario da loja, depende da
	 * implementação das classes herdeiras de Usuario, lança exceção para
	 * parametro vazio ou nulo
	 * 
	 * @param login
	 * @param dinheiro
	 */
	public void adicionaDinheiro(String login, double dinheiro) {
		Usuario novoUsuario = usuarioPorLogin(login);
		try {
			novoUsuario.setDinheiro(dinheiro);
		} catch (Exception e) {
			e.printStackTrace();
		}

	}

	/**
	 * Vende uma copia do jogo para o usuário caso ele possua dinheiro na conta
	 * para compra-lo e adiciona a coleção do usuario, lança exceções para
	 * parametros inválidos
	 * 
	 * @param login
	 * @param nome
	 * @param preco
	 * @param tipo
	 */
	public void venderJogo(String login, String nome, double preco, Tipo tipo) {
		Jogo novoJogo = null;
		try {
			novoJogo = new Jogo(nome, preco, tipo);
		} catch (Exception e) {
			e.printStackTrace();
		}
		Usuario novoUsuario = usuarioPorLogin(login);
		if (!novoUsuario.jogosComprados.contains(novoJogo) && novoUsuario.getDinheiro() >= novoJogo.getPreco())
			try {
				novoUsuario.Comprar(novoJogo);
			} catch (Exception e) {
				e.printStackTrace();
			}
	}

	/**
	 * Efetua migração de classe do usuario nos caso de ele já haver atinjido a
	 * pontuação de 1000 x2p, lançando exceção caso o mesmo já seja veterano ou
	 * os parametros passados sejam invalidos ou o mesmo não disponha de x2p
	 * suficiente
	 * 
	 * @param login
	 */
	public void upgrade(String login) {
		Usuario novoUsuario = usuarioPorLogin(login);
		try {
			if (novoUsuario.getX2p() >= 1000) {
				try {
					if (!Veterano.class.isInstance(novoUsuario)) {
						Veterano novoVeterano = new Veterano(novoUsuario.getNome(), novoUsuario.getLogin());
						novoVeterano.setDinheiro(novoUsuario.getDinheiro());
						novoVeterano.setX2p(novoUsuario.getX2p());
						novoVeterano.setJogosComprados(novoUsuario.getJogos());
						listaUsuarios.remove(novoUsuario);
						adicionaUsuario(novoVeterano);
					} else {
						throw new Exception("Usuario já é veterano");
					}
				} catch (Exception e) {
					e.printStackTrace();
				}
			} else {
				throw new Exception("Usuario não possui pontos suficientes para upgrade");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public ArrayList<Usuario> getListaUsuarios() {
		return listaUsuarios;
	}

	public void setListaUsuarios(ArrayList<Usuario> listaUsuarios) {
		this.listaUsuarios = listaUsuarios;
	}

	@Override
	public String toString() {
		String msg = "== Central P2-CG === " + NL + NL;
		for (Usuario novoUsuario : listaUsuarios) {
			msg += novoUsuario.toString() + NL;

		}
		msg += "--------------------------------------------" + NL;
		return msg;
	}
}
